rule win_strifewater_rat_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.strifewater_rat."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.strifewater_rat"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 747d 4883c018 498906 85db 7878 3b58f4 7f73 }
            // n = 7, score = 100
            //   747d                 | dec                 eax
            //   4883c018             | mov                 dword ptr [ecx], eax
            //   498906               | test                dl, 1
            //   85db                 | je                  0x11a
            //   7878                 | inc                 eax
            //   3b58f4               | push                ebx
            //   7f73                 | dec                 eax

        $sequence_1 = { 4889442458 4885c0 742e 488d4810 488d0560af0000 4889442420 4c8d0d34af0000 }
            // n = 7, score = 100
            //   4889442458           | dec                 esp
            //   4885c0               | lea                 eax, [ebp - 0x78]
            //   742e                 | dec                 eax
            //   488d4810             | lea                 edx, [esp + 0x60]
            //   488d0560af0000       | dec                 eax
            //   4889442420           | lea                 ecx, [esp + 0x58]
            //   4c8d0d34af0000       | test                eax, eax

        $sequence_2 = { 836370fe 488d05dc4d0800 488903 488b5b60 4885db 7432 488b4b08 }
            // n = 7, score = 100
            //   836370fe             | inc                 eax
            //   488d05dc4d0800       | mov                 bh, byte ptr [esp + 0x30]
            //   488903               | dec                 esp
            //   488b5b60             | lea                 ebp, [0x6455d]
            //   4885db               | inc                 esp
            //   7432                 | cmp                 byte ptr [esi + 8], al
            //   488b4b08             | inc                 ecx

        $sequence_3 = { e8???????? 90 488b7d27 488d5517 48837d2f10 480f435517 8bcf }
            // n = 7, score = 100
            //   e8????????           |                     
            //   90                   | dec                 ecx
            //   488b7d27             | inc                 edi
            //   488d5517             | inc                 esi
            //   48837d2f10           | cmp                 byte ptr [eax + edi], dh
            //   480f435517           | jne                 0x1786
            //   8bcf                 | dec                 eax

        $sequence_4 = { 0f44c8 498bc3 41880a 41c6420100 c3 4057 4883ec30 }
            // n = 7, score = 100
            //   0f44c8               | dec                 eax
            //   498bc3               | mov                 dword ptr [edi], eax
            //   41880a               | test                bl, 1
            //   41c6420100           | je                  0x1011
            //   c3                   | mov                 edx, 0x58
            //   4057                 | dec                 eax
            //   4883ec30             | mov                 ecx, edi

        $sequence_5 = { eb03 498bfc 4885ff 747a }
            // n = 4, score = 100
            //   eb03                 | mov                 dword ptr [ebp + 0x18], 1
            //   498bfc               | dec                 eax
            //   4885ff               | lea                 edx, [ebp + 0x18]
            //   747a                 | jne                 0x5a6

        $sequence_6 = { 400fb6d7 498bcf e8???????? 488b442430 48634804 83640c48fb 4533ff }
            // n = 7, score = 100
            //   400fb6d7             | dec                 eax
            //   498bcf               | mov                 edx, eax
            //   e8????????           |                     
            //   488b442430           | dec                 eax
            //   48634804             | mov                 ecx, ebx
            //   83640c48fb           | nop                 
            //   4533ff               | dec                 eax

        $sequence_7 = { 48d1f8 4883f80a 7326 488d0d2f0c0600 448a0408 498bd6 498bcf }
            // n = 7, score = 100
            //   48d1f8               | dec                 eax
            //   4883f80a             | lea                 ecx, [esp + 0x38]
            //   7326                 | int3                
            //   488d0d2f0c0600       | dec                 eax
            //   448a0408             | mov                 eax, esp
            //   498bd6               | dec                 eax
            //   498bcf               | lea                 edx, [0x8f52f]

        $sequence_8 = { 90 488d05750c0900 48898590010000 488bbd98010000 488b9da0010000 488bcb e8???????? }
            // n = 7, score = 100
            //   90                   | xor                 eax, esp
            //   488d05750c0900       | dec                 eax
            //   48898590010000       | mov                 dword ptr [ebp + 0x37], eax
            //   488bbd98010000       | dec                 eax
            //   488b9da0010000       | sub                 esp, 0xa0
            //   488bcb               | dec                 eax
            //   e8????????           |                     

        $sequence_9 = { 488d1555c40600 498bcc ffd3 33db 385e08 7508 488bce }
            // n = 7, score = 100
            //   488d1555c40600       | dec                 eax
            //   498bcc               | lea                 ecx, [0x65de4]
            //   ffd3                 | dec                 eax
            //   33db                 | mov                 dword ptr [ebx], ecx
            //   385e08               | nop                 
            //   7508                 | mov                 esi, 1
            //   488bce               | mov                 dword ptr [esp + 0xb0], esi

    condition:
        7 of them and filesize < 1552384
}