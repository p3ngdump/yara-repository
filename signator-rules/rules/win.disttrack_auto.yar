rule win_disttrack_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.disttrack."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.disttrack"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 52 6a00 6a00 6848000700 }
            // n = 4, score = 200
            //   52                   | xor                 ecx, esp
            //   6a00                 | dec                 eax
            //   6a00                 | mov                 ebx, eax
            //   6848000700           | dec                 eax

        $sequence_1 = { ff15???????? 5d 5b 8bc7 5f 5e }
            // n = 6, score = 200
            //   ff15????????         |                     
            //   5d                   | lea                 edx, [ebx + 0x30]
            //   5b                   | dec                 eax
            //   8bc7                 | lea                 ecx, [0xbf1c]
            //   5f                   | inc                 ebp
            //   5e                   | xor                 eax, eax

        $sequence_2 = { ebb2 6a16 58 5e 5d c3 6a0c }
            // n = 7, score = 200
            //   ebb2                 | jmp                 0xffffffb4
            //   6a16                 | push                0x16
            //   58                   | pop                 eax
            //   5e                   | pop                 esi
            //   5d                   | pop                 ebp
            //   c3                   | ret                 
            //   6a0c                 | push                0xc

        $sequence_3 = { ff15???????? 8d45dc 50 ff15???????? 8b4ddc }
            // n = 5, score = 200
            //   ff15????????         |                     
            //   8d45dc               | dec                 eax
            //   50                   | mov                 ecx, dword ptr [ebp - 8]
            //   ff15????????         |                     
            //   8b4ddc               | dec                 eax

        $sequence_4 = { e8???????? 6a07 e8???????? 59 c3 6a10 68???????? }
            // n = 7, score = 200
            //   e8????????           |                     
            //   6a07                 | push                7
            //   e8????????           |                     
            //   59                   | pop                 ecx
            //   c3                   | ret                 
            //   6a10                 | push                0x10
            //   68????????           |                     

        $sequence_5 = { 83c404 50 e8???????? 83c404 68???????? ff15???????? }
            // n = 6, score = 200
            //   83c404               | mov                 ecx, edi
            //   50                   | xor                 al, al
            //   e8????????           |                     
            //   83c404               | dec                 eax
            //   68????????           |                     
            //   ff15????????         |                     

        $sequence_6 = { 8b85b8feffff 8b8d04ffffff 8908 6a00 6a00 }
            // n = 5, score = 100
            //   8b85b8feffff         | push                eax
            //   8b8d04ffffff         | add                 esp, 4
            //   8908                 | add                 esp, 4
            //   6a00                 | push                eax
            //   6a00                 | add                 esp, 4

        $sequence_7 = { 8b430c 8905???????? 8bd7 4c8d0560f6feff }
            // n = 4, score = 100
            //   8b430c               | mov                 eax, dword ptr [ebx + 0xc]
            //   8905????????         |                     
            //   8bd7                 | mov                 edx, edi
            //   4c8d0560f6feff       | dec                 esp

        $sequence_8 = { e9???????? 8b7c2410 8d442420 50 8d4fff }
            // n = 5, score = 100
            //   e9????????           |                     
            //   8b7c2410             | mov                 edi, dword ptr [esp + 0x10]
            //   8d442420             | lea                 eax, [esp + 0x20]
            //   50                   | push                eax
            //   8d4fff               | lea                 ecx, [edi - 1]

        $sequence_9 = { 8d9540ffffff 8955a8 c7840dd0feffff6c2a4200 8d8de8feffff c745fc08000000 }
            // n = 5, score = 100
            //   8d9540ffffff         | pop                 edi
            //   8955a8               | pop                 esi
            //   c7840dd0feffff6c2a4200     | add    esp, 4
            //   8d8de8feffff         | push                eax
            //   c745fc08000000       | add                 esp, 4

        $sequence_10 = { c7466818684200 6a0d e8???????? 59 8365fc00 }
            // n = 5, score = 100
            //   c7466818684200       | add                 esp, 4
            //   6a0d                 | pop                 ebp
            //   e8????????           |                     
            //   59                   | pop                 ebx
            //   8365fc00             | mov                 eax, edi

        $sequence_11 = { 33db 48895c2458 4885d2 744b }
            // n = 4, score = 100
            //   33db                 | lea                 edx, [0x1f730]
            //   48895c2458           | dec                 eax
            //   4885d2               | mov                 ecx, esi
            //   744b                 | test                eax, eax

        $sequence_12 = { ff15???????? 488bd8 e9???????? ff15???????? 488bcf ff15???????? 32c0 }
            // n = 7, score = 100
            //   ff15????????         |                     
            //   488bd8               | dec                 eax
            //   e9????????           |                     
            //   ff15????????         |                     
            //   488bcf               | lea                 ecx, [0xa0db]
            //   ff15????????         |                     
            //   32c0                 | xor                 ebx, ebx

        $sequence_13 = { baa00f0000 ffc6 488d0c80 488d05765c0100 488d0cc8 48890f ff15???????? }
            // n = 7, score = 100
            //   baa00f0000           | lea                 eax, [0xfffef660]
            //   ffc6                 | mov                 edx, 0xfa0
            //   488d0c80             | inc                 esi
            //   488d05765c0100       | dec                 eax
            //   488d0cc8             | lea                 ecx, [eax + eax*4]
            //   48890f               | dec                 eax
            //   ff15????????         |                     

        $sequence_14 = { 33db 57 8945ec 3bf3 7508 }
            // n = 5, score = 100
            //   33db                 | pop                 esi
            //   57                   | lea                 eax, [ebp - 0x24]
            //   8945ec               | push                eax
            //   3bf3                 | mov                 ecx, dword ptr [ebp - 0x24]
            //   7508                 | add                 esp, 4

        $sequence_15 = { 7408 8a470c 3a410c 7d30 8b5608 }
            // n = 5, score = 100
            //   7408                 | push                ebx
            //   8a470c               | pop                 ebp
            //   3a410c               | pop                 ebx
            //   7d30                 | mov                 eax, edi
            //   8b5608               | pop                 edi

        $sequence_16 = { 8bd0 8d7001 8a08 40 84c9 75f9 }
            // n = 6, score = 100
            //   8bd0                 | mov                 edx, eax
            //   8d7001               | lea                 esi, [eax + 1]
            //   8a08                 | mov                 cl, byte ptr [eax]
            //   40                   | inc                 eax
            //   84c9                 | test                cl, cl
            //   75f9                 | jne                 0xfffffffb

        $sequence_17 = { 81ff00280000 7607 bf00280000 eb04 85ff }
            // n = 5, score = 100
            //   81ff00280000         | cmp                 edi, 0x2800
            //   7607                 | jbe                 9
            //   bf00280000           | mov                 edi, 0x2800
            //   eb04                 | jmp                 6
            //   85ff                 | test                edi, edi

        $sequence_18 = { 833c1800 7451 0fbf4f0a 8b1418 51 52 8d8528fcffff }
            // n = 7, score = 100
            //   833c1800             | cmp                 dword ptr [eax + ebx], 0
            //   7451                 | je                  0x53
            //   0fbf4f0a             | movsx               ecx, word ptr [edi + 0xa]
            //   8b1418               | mov                 edx, dword ptr [eax + ebx]
            //   51                   | push                ecx
            //   52                   | push                edx
            //   8d8528fcffff         | lea                 eax, [ebp - 0x3d8]

        $sequence_19 = { 85c0 7408 8bcb ff15???????? e8???????? 488d150aa10000 488d0ddba00000 }
            // n = 7, score = 100
            //   85c0                 | mov                 dword ptr [edi], ecx
            //   7408                 | mov                 edx, eax
            //   8bcb                 | dec                 eax
            //   ff15????????         |                     
            //   e8????????           |                     
            //   488d150aa10000       | lea                 ecx, [ebp + edx*2]
            //   488d0ddba00000       | dec                 eax

        $sequence_20 = { 8b8528f8ffff 8a08 888d23f8ffff 838528f8ffff01 }
            // n = 4, score = 100
            //   8b8528f8ffff         | lea                 eax, [ebp - 0x24]
            //   8a08                 | push                eax
            //   888d23f8ffff         | mov                 ecx, dword ptr [ebp - 0x24]
            //   838528f8ffff01       | lea                 eax, [ebp - 0x24]

        $sequence_21 = { 7405 e8???????? 8ac3 488b4df8 4833cc e8???????? }
            // n = 6, score = 100
            //   7405                 | je                  0xa
            //   e8????????           |                     
            //   8ac3                 | mov                 ecx, ebx
            //   488b4df8             | dec                 eax
            //   4833cc               | lea                 edx, [0xa10a]
            //   e8????????           |                     

        $sequence_22 = { 8b06 89442410 3bc3 7473 6800080000 e8???????? 8bf0 }
            // n = 7, score = 100
            //   8b06                 | mov                 eax, dword ptr [esi]
            //   89442410             | mov                 dword ptr [esp + 0x10], eax
            //   3bc3                 | cmp                 eax, ebx
            //   7473                 | je                  0x75
            //   6800080000           | push                0x800
            //   e8????????           |                     
            //   8bf0                 | mov                 esi, eax

        $sequence_23 = { 488d5330 488d0d1cbf0000 4533c0 4c891d???????? e8???????? }
            // n = 5, score = 100
            //   488d5330             | dec                 eax
            //   488d0d1cbf0000       | mov                 dword ptr [esp + 0x58], ebx
            //   4533c0               | dec                 eax
            //   4c891d????????       |                     
            //   e8????????           |                     

        $sequence_24 = { e8???????? 8bd0 488d4c5500 488d1530f70100 e8???????? 488bce }
            // n = 6, score = 100
            //   e8????????           |                     
            //   8bd0                 | lea                 eax, [0x15c76]
            //   488d4c5500           | dec                 eax
            //   488d1530f70100       | lea                 ecx, [eax + ecx*8]
            //   e8????????           |                     
            //   488bce               | dec                 eax

        $sequence_25 = { ff15???????? 898740004200 83c704 83ff28 72e6 }
            // n = 5, score = 100
            //   ff15????????         |                     
            //   898740004200         | mov                 dword ptr [edi + 0x420040], eax
            //   83c704               | add                 edi, 4
            //   83ff28               | cmp                 edi, 0x28
            //   72e6                 | jb                  0xffffffe8

    condition:
        7 of them and filesize < 1112064
}