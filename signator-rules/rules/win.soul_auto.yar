rule win_soul_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.soul."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.soul"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { d3e2 8515???????? 7405 e8???????? }
            // n = 4, score = 400
            //   d3e2                 | shl                 edx, cl
            //   8515????????         |                     
            //   7405                 | je                  7
            //   e8????????           |                     

        $sequence_1 = { 8b7d08 8b4f38 8b4710 8b573c 8945e0 8b4740 }
            // n = 6, score = 400
            //   8b7d08               | mov                 edi, dword ptr [ebp + 8]
            //   8b4f38               | mov                 ecx, dword ptr [edi + 0x38]
            //   8b4710               | mov                 eax, dword ptr [edi + 0x10]
            //   8b573c               | mov                 edx, dword ptr [edi + 0x3c]
            //   8945e0               | mov                 dword ptr [ebp - 0x20], eax
            //   8b4740               | mov                 eax, dword ptr [edi + 0x40]

        $sequence_2 = { 8be5 5d c3 57 eb05 }
            // n = 5, score = 400
            //   8be5                 | mov                 esp, ebp
            //   5d                   | pop                 ebp
            //   c3                   | ret                 
            //   57                   | push                edi
            //   eb05                 | jmp                 7

        $sequence_3 = { c1eb0b 0fafdf 3bf3 731a 8bc3 }
            // n = 5, score = 400
            //   c1eb0b               | shr                 ebx, 0xb
            //   0fafdf               | imul                ebx, edi
            //   3bf3                 | cmp                 esi, ebx
            //   731a                 | jae                 0x1c
            //   8bc3                 | mov                 eax, ebx

        $sequence_4 = { 8bd1 8d9cdf04010000 8945ec 8945f0 eb18 }
            // n = 5, score = 400
            //   8bd1                 | mov                 edx, ecx
            //   8d9cdf04010000       | lea                 ebx, [edi + ebx*8 + 0x104]
            //   8945ec               | mov                 dword ptr [ebp - 0x14], eax
            //   8945f0               | mov                 dword ptr [ebp - 0x10], eax
            //   eb18                 | jmp                 0x1a

        $sequence_5 = { 8d4c0901 81f900010000 72b4 b801000000 e9???????? 8b4f24 8b5f38 }
            // n = 7, score = 400
            //   8d4c0901             | lea                 ecx, [ecx + ecx + 1]
            //   81f900010000         | cmp                 ecx, 0x100
            //   72b4                 | jb                  0xffffffb6
            //   b801000000           | mov                 eax, 1
            //   e9????????           |                     
            //   8b4f24               | mov                 ecx, dword ptr [edi + 0x24]
            //   8b5f38               | mov                 ebx, dword ptr [edi + 0x38]

        $sequence_6 = { 7318 3b45fc 0f8371030000 0fb608 c1e608 c1e208 }
            // n = 6, score = 400
            //   7318                 | jae                 0x1a
            //   3b45fc               | cmp                 eax, dword ptr [ebp - 4]
            //   0f8371030000         | jae                 0x377
            //   0fb608               | movzx               ecx, byte ptr [eax]
            //   c1e608               | shl                 esi, 8
            //   c1e208               | shl                 edx, 8

        $sequence_7 = { e8???????? 83c408 85c0 741c 83c308 833b00 }
            // n = 6, score = 400
            //   e8????????           |                     
            //   83c408               | add                 esp, 8
            //   85c0                 | test                eax, eax
            //   741c                 | je                  0x1e
            //   83c308               | add                 ebx, 8
            //   833b00               | cmp                 dword ptr [ebx], 0

        $sequence_8 = { ff25???????? 48895c2408 4889742410 57 }
            // n = 4, score = 400
            //   ff25????????         |                     
            //   48895c2408           | dec                 eax
            //   4889742410           | mov                 dword ptr [esp + 8], ebx
            //   57                   | dec                 eax

        $sequence_9 = { 0f83af010000 8bc2 ba00080000 2bd1 c1ea05 }
            // n = 5, score = 400
            //   0f83af010000         | jae                 0x1b5
            //   8bc2                 | mov                 eax, edx
            //   ba00080000           | mov                 edx, 0x800
            //   2bd1                 | sub                 edx, ecx
            //   c1ea05               | shr                 edx, 5

        $sequence_10 = { 5f c3 48895c2430 488d99ff0f0000 41b904000000 4881e300f0ffff 41b800100000 }
            // n = 7, score = 200
            //   5f                   | inc                 ecx
            //   c3                   | lea                 ecx, [edx - 1]
            //   48895c2430           | mov                 edx, 1
            //   488d99ff0f0000       | je                  0x100
            //   41b904000000         | dec                 eax
            //   4881e300f0ffff       | add                 edi, eax
            //   41b800100000         | dec                 eax

        $sequence_11 = { 48833d????????00 741e 488d0d49ad0000 e8???????? 85c0 740e ba01000000 }
            // n = 7, score = 200
            //   48833d????????00     |                     
            //   741e                 | inc                 ecx
            //   488d0d49ad0000       | movzx               eax, byte ptr [esp]
            //   e8????????           |                     
            //   85c0                 | mov                 ecx, edi
            //   740e                 | add                 edi, 8
            //   ba01000000           | shl                 eax, cl

        $sequence_12 = { 85f6 7ecd 85db 7ec9 4863c3 4863fe 488d8dc0530000 }
            // n = 7, score = 200
            //   85f6                 | push                edi
            //   7ecd                 | dec                 eax
            //   85db                 | sub                 esp, 0x30
            //   7ec9                 | dec                 eax
            //   4863c3               | mov                 ebx, ecx
            //   4863fe               | dec                 eax
            //   488d8dc0530000       | mov                 dword ptr [esp + 8], ebx

        $sequence_13 = { 488b8128010000 488bd9 4885c0 7479 488d0dfbfc0000 483bc1 746d }
            // n = 7, score = 200
            //   488b8128010000       | add                 ebp, eax
            //   488bd9               | cmp                 edi, 0x10
            //   4885c0               | jb                  0x34
            //   7479                 | inc                 ecx
            //   488d0dfbfc0000       | test                byte ptr [esi + 0x10], 4
            //   483bc1               | je                  0x7b
            //   746d                 | inc                 ecx

        $sequence_14 = { 85f6 0f84040c0000 410fb60424 8bcf 83c708 d3e0 ffce }
            // n = 7, score = 200
            //   85f6                 | dec                 eax
            //   0f84040c0000         | mov                 dword ptr [esp + 0x10], esi
            //   410fb60424           | push                edi
            //   8bcf                 | dec                 eax
            //   83c708               | mov                 dword ptr [esp + 8], ebx
            //   d3e0                 | dec                 eax
            //   ffce                 | mov                 dword ptr [esp + 0x10], esi

        $sequence_15 = { 0f84e4000000 4803f8 482bd8 75d0 0fb68424cb000000 0fb69c24cc000000 }
            // n = 6, score = 200
            //   0f84e4000000         | dec                 eax
            //   4803f8               | sub                 esp, 0x30
            //   482bd8               | dec                 eax
            //   75d0                 | mov                 ebx, ecx
            //   0fb68424cb000000     | dec                 eax
            //   0fb69c24cc000000     | mov                 dword ptr [esp + 8], ebx

        $sequence_16 = { 49ffc4 4403e8 83ff10 72df 41f6461004 741f 410fb74620 }
            // n = 7, score = 200
            //   49ffc4               | push                edi
            //   4403e8               | dec                 eax
            //   83ff10               | sub                 esp, 0x30
            //   72df                 | dec                 eax
            //   41f6461004           | mov                 dword ptr [esp + 8], ebx
            //   741f                 | dec                 eax
            //   410fb74620           | mov                 dword ptr [esp + 0x10], esi

        $sequence_17 = { 0f85a5000000 488bcb e8???????? 488d155c0b0100 413bc7 }
            // n = 5, score = 200
            //   0f85a5000000         | dec                 esi
            //   488bcb               | dec                 ecx
            //   e8????????           |                     
            //   488d155c0b0100       | inc                 esp
            //   413bc7               | inc                 esp

        $sequence_18 = { 412bd0 412bf8 41890497 75f4 418d4aff ba01000000 }
            // n = 6, score = 200
            //   412bd0               | push                edi
            //   412bf8               | dec                 eax
            //   41890497             | mov                 dword ptr [esp + 8], ebx
            //   75f4                 | dec                 eax
            //   418d4aff             | mov                 dword ptr [esp + 0x10], esi
            //   ba01000000           | push                edi

        $sequence_19 = { 8b0424 4c3bf8 480f424c2428 41ffc3 482bc8 44899c24a8000000 }
            // n = 6, score = 200
            //   8b0424               | sub                 ebx, eax
            //   4c3bf8               | jne                 0xfffffff4
            //   480f424c2428         | movzx               eax, byte ptr [esp + 0xcb]
            //   41ffc3               | movzx               ebx, byte ptr [esp + 0xcc]
            //   482bc8               | test                esi, esi
            //   44899c24a8000000     | je                  0xc40

        $sequence_20 = { 452bc3 662bc8 6641890c5e 430fb78c5680010000 }
            // n = 4, score = 200
            //   452bc3               | dec                 eax
            //   662bc8               | mov                 dword ptr [esp + 0x10], esi
            //   6641890c5e           | push                edi
            //   430fb78c5680010000     | inc    ecx

        $sequence_21 = { 488d8db0010000 33d2 41b8cc020000 e8???????? 8b4304 4533e4 44882430 }
            // n = 7, score = 200
            //   488d8db0010000       | dec                 eax
            //   33d2                 | mov                 dword ptr [esp + 0x10], esi
            //   41b8cc020000         | push                edi
            //   e8????????           |                     
            //   8b4304               | inc                 ecx
            //   4533e4               | sub                 edx, eax
            //   44882430             | inc                 ecx

        $sequence_22 = { 66666666660f1f840000000000 0fb60411 48ffc2 8842ff 493bd2 75f1 }
            // n = 6, score = 200
            //   66666666660f1f840000000000     | sub    edx, eax
            //   0fb60411             | inc                 ecx
            //   48ffc2               | sub                 edi, eax
            //   8842ff               | inc                 ecx
            //   493bd2               | mov                 dword ptr [edi + edx*4], eax
            //   75f1                 | jne                 1

    condition:
        7 of them and filesize < 1400832
}