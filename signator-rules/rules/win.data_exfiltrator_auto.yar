rule win_data_exfiltrator_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.data_exfiltrator."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.data_exfiltrator"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { eb71 488b4c2450 e8???????? ffc0 89442420 4863442420 4889442430 }
            // n = 7, score = 100
            //   eb71                 | mov                 eax, ecx
            //   488b4c2450           | xor                 eax, eax
            //   e8????????           |                     
            //   ffc0                 | dec                 eax
            //   89442420             | mov                 eax, dword ptr [esp + 0x70]
            //   4863442420           | dec                 eax
            //   4889442430           | arpl                word ptr [eax + 0x3c], ax

        $sequence_1 = { c684248200000081 c684248300000083 c684248400000075 c68424850000007e c684248600000045 c684248700000045 c684248800000070 }
            // n = 7, score = 100
            //   c684248200000081     | dec                 eax
            //   c684248300000083     | mov                 edx, dword ptr [esp + 0x50]
            //   c684248400000075     | test                eax, eax
            //   c68424850000007e     | jne                 0x769
            //   c684248600000045     | jmp                 0x797
            //   c684248700000045     | dec                 eax
            //   c684248800000070     | mov                 ecx, dword ptr [esp + 0x50]

        $sequence_2 = { 48ffc0 4889442428 488b442428 488b4c2478 4803c8 488bc1 }
            // n = 6, score = 100
            //   48ffc0               | mov                 byte ptr [esp + 0xba], 0x82
            //   4889442428           | mov                 byte ptr [esp + 0xb7], 0x6d
            //   488b442428           | mov                 byte ptr [esp + 0xb8], 0x4f
            //   488b4c2478           | mov                 byte ptr [esp + 0xb9], 0x72
            //   4803c8               | mov                 byte ptr [esp + 0xba], 0x78
            //   488bc1               | mov                 byte ptr [esp + 0xbb], 0x78

        $sequence_3 = { 488b8918400000 488d440105 483b842480000000 7610 488b442460 }
            // n = 5, score = 100
            //   488b8918400000       | shl                 ecx, 8
            //   488d440105           | add                 eax, ecx
            //   483b842480000000     | movsx               ecx, byte ptr [esp + 0x38]
            //   7610                 | add                 eax, ecx
            //   488b442460           | movsx               ecx, byte ptr [esp + 0x38]

        $sequence_4 = { 4883ec38 8b442448 4889442420 41b900800000 4c8d442420 488b542440 48c7c1ffffffff }
            // n = 7, score = 100
            //   4883ec38             | dec                 eax
            //   8b442448             | mov                 eax, dword ptr [esp + 0x78]
            //   4889442420           | dec                 eax
            //   41b900800000         | mov                 edx, dword ptr [edx + 0x58]
            //   4c8d442420           | dec                 eax
            //   488b542440           | mov                 dword ptr [esp + 0x20], edx
            //   48c7c1ffffffff       | inc                 ecx

        $sequence_5 = { 0fb74c2428 668908 b001 eb25 8b4c2420 e8???????? }
            // n = 6, score = 100
            //   0fb74c2428           | dec                 eax
            //   668908               | mov                 dword ptr [esp + 0x30], eax
            //   b001                 | dec                 eax
            //   eb25                 | cdq                 
            //   8b4c2420             | dec                 eax
            //   e8????????           |                     

        $sequence_6 = { c684249900000078 c684249a00000078 c684249b00000000 488d4c2470 }
            // n = 4, score = 100
            //   c684249900000078     | dec                 eax
            //   c684249a00000078     | mov                 dword ptr [esp + 0x38], 0
            //   c684249b00000000     | jl                  0xd6c
            //   488d4c2470           | mov                 eax, dword ptr [esp + 0x48]

        $sequence_7 = { c6442424aa c64424254d c644242671 c644242764 c644242868 }
            // n = 5, score = 100
            //   c6442424aa           | mov                 eax, dword ptr [eax + 0x20]
            //   c64424254d           | dec                 eax
            //   c644242671           | mov                 dword ptr [esp + 0x28], eax
            //   c644242764           | dec                 eax
            //   c644242868           | mov                 edx, dword ptr [esp + 0x50]

        $sequence_8 = { 4889442410 0fb6442408 4833442410 488d0d157d0000 }
            // n = 4, score = 100
            //   4889442410           | mov                 ecx, dword ptr [esp + 0x40]
            //   0fb6442408           | movsx               eax, byte ptr [ecx + eax]
            //   4833442410           | cmp                 eax, 0x2d
            //   488d0d157d0000       | dec                 eax

        $sequence_9 = { c6842483000000ff c6842484000000aa c68424850000004a c684248600000070 c684248700000077 c684248800000069 }
            // n = 6, score = 100
            //   c6842483000000ff     | cmp                 dword ptr [esp + 0x30], eax
            //   c6842484000000aa     | dec                 eax
            //   c68424850000004a     | add                 eax, 0x2c
            //   c684248600000070     | dec                 eax
            //   c684248700000077     | mov                 ecx, eax
            //   c684248800000069     | movzx               eax, al

    condition:
        7 of them and filesize < 107520
}