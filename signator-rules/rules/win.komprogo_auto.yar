rule win_komprogo_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.komprogo."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.komprogo"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 83c40c 3bfe 7454 8d4c2478 51 8d942486020000 52 }
            // n = 7, score = 100
            //   83c40c               | add                 esp, 0xc
            //   3bfe                 | cmp                 edi, esi
            //   7454                 | je                  0x56
            //   8d4c2478             | lea                 ecx, [esp + 0x78]
            //   51                   | push                ecx
            //   8d942486020000       | lea                 edx, [esp + 0x286]
            //   52                   | push                edx

        $sequence_1 = { 8b95d4f3ffff 8b3d???????? 52 ffd7 8b85d0f3ffff 50 ffd7 }
            // n = 7, score = 100
            //   8b95d4f3ffff         | mov                 edx, dword ptr [ebp - 0xc2c]
            //   8b3d????????         |                     
            //   52                   | push                edx
            //   ffd7                 | call                edi
            //   8b85d0f3ffff         | mov                 eax, dword ptr [ebp - 0xc30]
            //   50                   | push                eax
            //   ffd7                 | call                edi

        $sequence_2 = { 8d8604720300 89863e3e0000 8d8634700300 8986813e0000 8d8e12480300 898eaca90300 8d8e10700300 }
            // n = 7, score = 100
            //   8d8604720300         | lea                 eax, [esi + 0x37204]
            //   89863e3e0000         | mov                 dword ptr [esi + 0x3e3e], eax
            //   8d8634700300         | lea                 eax, [esi + 0x37034]
            //   8986813e0000         | mov                 dword ptr [esi + 0x3e81], eax
            //   8d8e12480300         | lea                 ecx, [esi + 0x34812]
            //   898eaca90300         | mov                 dword ptr [esi + 0x3a9ac], ecx
            //   8d8e10700300         | lea                 ecx, [esi + 0x37010]

        $sequence_3 = { 0f842e290000 8d9630950300 89965f370300 8d86c0bf0300 898624c00300 8d8e60ae0300 }
            // n = 6, score = 100
            //   0f842e290000         | je                  0x2934
            //   8d9630950300         | lea                 edx, [esi + 0x39530]
            //   89965f370300         | mov                 dword ptr [esi + 0x3375f], edx
            //   8d86c0bf0300         | lea                 eax, [esi + 0x3bfc0]
            //   898624c00300         | mov                 dword ptr [esi + 0x3c024], eax
            //   8d8e60ae0300         | lea                 ecx, [esi + 0x3ae60]

        $sequence_4 = { 8d8ef0660300 898e24ba0300 8d8e74700300 898ee7510000 8d9630ba0300 899650ba0300 8986f4020100 }
            // n = 7, score = 100
            //   8d8ef0660300         | lea                 ecx, [esi + 0x366f0]
            //   898e24ba0300         | mov                 dword ptr [esi + 0x3ba24], ecx
            //   8d8e74700300         | lea                 ecx, [esi + 0x37074]
            //   898ee7510000         | mov                 dword ptr [esi + 0x51e7], ecx
            //   8d9630ba0300         | lea                 edx, [esi + 0x3ba30]
            //   899650ba0300         | mov                 dword ptr [esi + 0x3ba50], edx
            //   8986f4020100         | mov                 dword ptr [esi + 0x102f4], eax

        $sequence_5 = { ff15???????? 57 ff15???????? b84d5a0000 663b06 0f85a7000000 }
            // n = 6, score = 100
            //   ff15????????         |                     
            //   57                   | push                edi
            //   ff15????????         |                     
            //   b84d5a0000           | mov                 eax, 0x5a4d
            //   663b06               | cmp                 ax, word ptr [esi]
            //   0f85a7000000         | jne                 0xad

        $sequence_6 = { 0fb6c0 eb12 8b45e0 8a80bca94200 08443b1d 0fb64601 }
            // n = 6, score = 100
            //   0fb6c0               | movzx               eax, al
            //   eb12                 | jmp                 0x14
            //   8b45e0               | mov                 eax, dword ptr [ebp - 0x20]
            //   8a80bca94200         | mov                 al, byte ptr [eax + 0x42a9bc]
            //   08443b1d             | or                  byte ptr [ebx + edi + 0x1d], al
            //   0fb64601             | movzx               eax, byte ptr [esi + 1]

        $sequence_7 = { 803d????????00 7517 68???????? 8d4602 50 ff15???????? }
            // n = 6, score = 100
            //   803d????????00       |                     
            //   7517                 | jne                 0x19
            //   68????????           |                     
            //   8d4602               | lea                 eax, [esi + 2]
            //   50                   | push                eax
            //   ff15????????         |                     

        $sequence_8 = { 8d55f4 52 57 57 50 897df4 }
            // n = 6, score = 100
            //   8d55f4               | lea                 edx, [ebp - 0xc]
            //   52                   | push                edx
            //   57                   | push                edi
            //   57                   | push                edi
            //   50                   | push                eax
            //   897df4               | mov                 dword ptr [ebp - 0xc], edi

        $sequence_9 = { 8d86f8980300 89860e060100 8d96ce6d0300 899664c30300 8d86d96d0300 89866cc30300 8d8ee16d0300 }
            // n = 7, score = 100
            //   8d86f8980300         | lea                 eax, [esi + 0x398f8]
            //   89860e060100         | mov                 dword ptr [esi + 0x1060e], eax
            //   8d96ce6d0300         | lea                 edx, [esi + 0x36dce]
            //   899664c30300         | mov                 dword ptr [esi + 0x3c364], edx
            //   8d86d96d0300         | lea                 eax, [esi + 0x36dd9]
            //   89866cc30300         | mov                 dword ptr [esi + 0x3c36c], eax
            //   8d8ee16d0300         | lea                 ecx, [esi + 0x36de1]

    condition:
        7 of them and filesize < 1045504
}