rule win_daserf_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.daserf."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.daserf"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 95 89ac2440f1ffff 8be8 8b842440f1ffff 81ebc555f2f1 }
            // n = 5, score = 100
            //   95                   | xchg                eax, ebp
            //   89ac2440f1ffff       | mov                 dword ptr [esp - 0xec0], ebp
            //   8be8                 | mov                 ebp, eax
            //   8b842440f1ffff       | mov                 eax, dword ptr [esp - 0xec0]
            //   81ebc555f2f1         | sub                 ebx, 0xf1f255c5

        $sequence_1 = { 89ac2420f5ffff 8be8 8b842420f5ffff 68???????? 8bed 50 8bc9 }
            // n = 7, score = 100
            //   89ac2420f5ffff       | mov                 dword ptr [esp - 0xae0], ebp
            //   8be8                 | mov                 ebp, eax
            //   8b842420f5ffff       | mov                 eax, dword ptr [esp - 0xae0]
            //   68????????           |                     
            //   8bed                 | mov                 ebp, ebp
            //   50                   | push                eax
            //   8bc9                 | mov                 ecx, ecx

        $sequence_2 = { 05fa1bd32e 2de9d4a475 81c332cf524d 81c3d56e0540 2da16cfd71 }
            // n = 5, score = 100
            //   05fa1bd32e           | add                 eax, 0x2ed31bfa
            //   2de9d4a475           | sub                 eax, 0x75a4d4e9
            //   81c332cf524d         | add                 ebx, 0x4d52cf32
            //   81c3d56e0540         | add                 ebx, 0x40056ed5
            //   2da16cfd71           | sub                 eax, 0x71fd6ca1

        $sequence_3 = { 81eb53f193e1 81eb82950665 81eb42f956b3 81ebc1fae340 }
            // n = 4, score = 100
            //   81eb53f193e1         | sub                 ebx, 0xe193f153
            //   81eb82950665         | sub                 ebx, 0x65069582
            //   81eb42f956b3         | sub                 ebx, 0xb356f942
            //   81ebc1fae340         | sub                 ebx, 0x40e3fac1

        $sequence_4 = { 90 05d7938ba9 8d1b 81eb76c01ae6 }
            // n = 4, score = 100
            //   90                   | nop                 
            //   05d7938ba9           | add                 eax, 0xa98b93d7
            //   8d1b                 | lea                 ebx, [ebx]
            //   81eb76c01ae6         | sub                 ebx, 0xe61ac076

        $sequence_5 = { 2d85e5dc9d 81eb30df3499 81eb693c6ca6 81c3fef12402 81eb4e8b9792 05d9aff1e0 }
            // n = 6, score = 100
            //   2d85e5dc9d           | sub                 eax, 0x9ddce585
            //   81eb30df3499         | sub                 ebx, 0x9934df30
            //   81eb693c6ca6         | sub                 ebx, 0xa66c3c69
            //   81c3fef12402         | add                 ebx, 0x224f1fe
            //   81eb4e8b9792         | sub                 ebx, 0x92978b4e
            //   05d9aff1e0           | add                 eax, 0xe0f1afd9

        $sequence_6 = { 81c37b8a43cc 2d7531d618 81ebb2650926 81ebf9bafa01 054e9ee27b 81ebb1c38872 }
            // n = 6, score = 100
            //   81c37b8a43cc         | add                 ebx, 0xcc438a7b
            //   2d7531d618           | sub                 eax, 0x18d63175
            //   81ebb2650926         | sub                 ebx, 0x260965b2
            //   81ebf9bafa01         | sub                 ebx, 0x1fabaf9
            //   054e9ee27b           | add                 eax, 0x7be29e4e
            //   81ebb1c38872         | sub                 ebx, 0x7288c3b1

        $sequence_7 = { 50 6a02 ff15???????? 57 ff15???????? 0fbf480a }
            // n = 6, score = 100
            //   50                   | push                eax
            //   6a02                 | push                2
            //   ff15????????         |                     
            //   57                   | push                edi
            //   ff15????????         |                     
            //   0fbf480a             | movsx               ecx, word ptr [eax + 0xa]

        $sequence_8 = { 81c32bef6e96 81c3b4dacce0 81c3fd073dc7 81c35ac1f1c8 81eb7a605ab6 0521c15b3f }
            // n = 6, score = 100
            //   81c32bef6e96         | add                 ebx, 0x966eef2b
            //   81c3b4dacce0         | add                 ebx, 0xe0ccdab4
            //   81c3fd073dc7         | add                 ebx, 0xc73d07fd
            //   81c35ac1f1c8         | add                 ebx, 0xc8f1c15a
            //   81eb7a605ab6         | sub                 ebx, 0xb65a607a
            //   0521c15b3f           | add                 eax, 0x3f5bc121

        $sequence_9 = { 8b842410f1ffff 054999161c 8bd2 0564f44076 7500 }
            // n = 5, score = 100
            //   8b842410f1ffff       | mov                 eax, dword ptr [esp - 0xef0]
            //   054999161c           | add                 eax, 0x1c169949
            //   8bd2                 | mov                 edx, edx
            //   0564f44076           | add                 eax, 0x7640f464
            //   7500                 | jne                 2

        $sequence_10 = { 81ebac7e1a8b 7500 05c629e3c3 8d3f 81c394605a15 f7d4 f7d4 }
            // n = 7, score = 100
            //   81ebac7e1a8b         | sub                 ebx, 0x8b1a7eac
            //   7500                 | jne                 2
            //   05c629e3c3           | add                 eax, 0xc3e329c6
            //   8d3f                 | lea                 edi, [edi]
            //   81c394605a15         | add                 ebx, 0x155a6094
            //   f7d4                 | not                 esp
            //   f7d4                 | not                 esp

        $sequence_11 = { ffb5cca7ffff 8d85bc4fffff 50 ffd3 8d85a014ffff }
            // n = 5, score = 100
            //   ffb5cca7ffff         | push                dword ptr [ebp - 0x5834]
            //   8d85bc4fffff         | lea                 eax, [ebp - 0xb044]
            //   50                   | push                eax
            //   ffd3                 | call                ebx
            //   8d85a014ffff         | lea                 eax, [ebp - 0xeb60]

        $sequence_12 = { 2d71a43cdd 2daed082b8 81eba9eed8bc 81eb4f80e44f }
            // n = 4, score = 100
            //   2d71a43cdd           | sub                 eax, 0xdd3ca471
            //   2daed082b8           | sub                 eax, 0xb882d0ae
            //   81eba9eed8bc         | sub                 ebx, 0xbcd8eea9
            //   81eb4f80e44f         | sub                 ebx, 0x4fe4804f

        $sequence_13 = { 2d2aac4833 f7d4 f7d4 81c32c67a890 7500 058499e6dc 8d36 }
            // n = 7, score = 100
            //   2d2aac4833           | sub                 eax, 0x3348ac2a
            //   f7d4                 | not                 esp
            //   f7d4                 | not                 esp
            //   81c32c67a890         | add                 ebx, 0x90a8672c
            //   7500                 | jne                 2
            //   058499e6dc           | add                 eax, 0xdce69984
            //   8d36                 | lea                 esi, [esi]

        $sequence_14 = { 55 8d12 8bec 9b 81ec04040000 92 }
            // n = 6, score = 100
            //   55                   | push                ebp
            //   8d12                 | lea                 edx, [edx]
            //   8bec                 | mov                 ebp, esp
            //   9b                   | wait                
            //   81ec04040000         | sub                 esp, 0x404
            //   92                   | xchg                eax, edx

        $sequence_15 = { f7d5 0582f4f2b9 7500 05cba9a307 f7d6 f7d6 }
            // n = 6, score = 100
            //   f7d5                 | not                 ebp
            //   0582f4f2b9           | add                 eax, 0xb9f2f482
            //   7500                 | jne                 2
            //   05cba9a307           | add                 eax, 0x7a3a9cb
            //   f7d6                 | not                 esi
            //   f7d6                 | not                 esi

    condition:
        7 of them and filesize < 245760
}