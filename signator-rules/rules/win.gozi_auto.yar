rule win_gozi_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-05-16"
        version = "1"
        description = "Detects win.gozi."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.gozi"
        malpedia_rule_date = "20220513"
        malpedia_hash = "7f4b2229e6ae614d86d74917f6d5b41890e62a26"
        malpedia_version = "20220516"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b55ac 0b55b0 7420 96 0fc0d6 }
            // n = 5, score = 100
            //   8b55ac               | mov                 edx, dword ptr [ebp - 0x54]
            //   0b55b0               | or                  edx, dword ptr [ebp - 0x50]
            //   7420                 | je                  0x22
            //   96                   | xchg                eax, esi
            //   0fc0d6               | xadd                dh, dl

        $sequence_1 = { 0fbdf1 f6c5be d2ca 86d6 }
            // n = 4, score = 100
            //   0fbdf1               | bsr                 esi, ecx
            //   f6c5be               | test                ch, 0xbe
            //   d2ca                 | ror                 dl, cl
            //   86d6                 | xchg                dh, dl

        $sequence_2 = { f3a5 8bcb f3a4 5f 5e 5b }
            // n = 6, score = 100
            //   f3a5                 | rep movsd           dword ptr es:[edi], dword ptr [esi]
            //   8bcb                 | mov                 ecx, ebx
            //   f3a4                 | rep movsb           byte ptr es:[edi], byte ptr [esi]
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi
            //   5b                   | pop                 ebx

        $sequence_3 = { e8???????? ff7014 e8???????? 89b504f4ffff 56 e8???????? }
            // n = 6, score = 100
            //   e8????????           |                     
            //   ff7014               | push                dword ptr [eax + 0x14]
            //   e8????????           |                     
            //   89b504f4ffff         | mov                 dword ptr [ebp - 0xbfc], esi
            //   56                   | push                esi
            //   e8????????           |                     

        $sequence_4 = { b87e8da638 e022 3a56b9 036890 }
            // n = 4, score = 100
            //   b87e8da638           | mov                 eax, 0x38a68d7e
            //   e022                 | loopne              0x24
            //   3a56b9               | cmp                 dl, byte ptr [esi - 0x47]
            //   036890               | add                 ebp, dword ptr [eax - 0x70]

        $sequence_5 = { 2b02 9a102a6715fb53 31db b0a6 46 312d???????? ca065b }
            // n = 7, score = 100
            //   2b02                 | sub                 eax, dword ptr [edx]
            //   9a102a6715fb53       | lcall               0x53fb:0x15672a10
            //   31db                 | xor                 ebx, ebx
            //   b0a6                 | mov                 al, 0xa6
            //   46                   | inc                 esi
            //   312d????????         |                     
            //   ca065b               | retf                0x5b06

        $sequence_6 = { 80bd7dfdffff01 0f851affffff 895db8 8d45b8 }
            // n = 4, score = 100
            //   80bd7dfdffff01       | cmp                 byte ptr [ebp - 0x283], 1
            //   0f851affffff         | jne                 0xffffff20
            //   895db8               | mov                 dword ptr [ebp - 0x48], ebx
            //   8d45b8               | lea                 eax, [ebp - 0x48]

        $sequence_7 = { 7415 53 53 8d85d0f4ffff 50 ffb538f4ffff }
            // n = 6, score = 100
            //   7415                 | je                  0x17
            //   53                   | push                ebx
            //   53                   | push                ebx
            //   8d85d0f4ffff         | lea                 eax, [ebp - 0xb30]
            //   50                   | push                eax
            //   ffb538f4ffff         | push                dword ptr [ebp - 0xbc8]

        $sequence_8 = { 33745571 de7e75 cd18 4a 51 d2b8c512294e }
            // n = 6, score = 100
            //   33745571             | xor                 esi, dword ptr [ebp + edx*2 + 0x71]
            //   de7e75               | fidivr              word ptr [esi + 0x75]
            //   cd18                 | int                 0x18
            //   4a                   | dec                 edx
            //   51                   | push                ecx
            //   d2b8c512294e         | sar                 byte ptr [eax + 0x4e2912c5], cl

        $sequence_9 = { 85c0 0f94c3 ff75fc e8???????? 8bc3 5b }
            // n = 6, score = 100
            //   85c0                 | test                eax, eax
            //   0f94c3               | sete                bl
            //   ff75fc               | push                dword ptr [ebp - 4]
            //   e8????????           |                     
            //   8bc3                 | mov                 eax, ebx
            //   5b                   | pop                 ebx

        $sequence_10 = { ff7028 e8???????? 85c0 0f84aa000000 c785a8fcffff00010000 8d85a8fcffff }
            // n = 6, score = 100
            //   ff7028               | push                dword ptr [eax + 0x28]
            //   e8????????           |                     
            //   85c0                 | test                eax, eax
            //   0f84aa000000         | je                  0xb0
            //   c785a8fcffff00010000     | mov    dword ptr [ebp - 0x358], 0x100
            //   8d85a8fcffff         | lea                 eax, [ebp - 0x358]

        $sequence_11 = { 8365fc00 bf???????? 57 8b35???????? }
            // n = 4, score = 100
            //   8365fc00             | and                 dword ptr [ebp - 4], 0
            //   bf????????           |                     
            //   57                   | push                edi
            //   8b35????????         |                     

        $sequence_12 = { 8995ccfeffff 8b95c8feffff 0b95ccfeffff 7427 }
            // n = 4, score = 100
            //   8995ccfeffff         | mov                 dword ptr [ebp - 0x134], edx
            //   8b95c8feffff         | mov                 edx, dword ptr [ebp - 0x138]
            //   0b95ccfeffff         | or                  edx, dword ptr [ebp - 0x134]
            //   7427                 | je                  0x29

        $sequence_13 = { e8???????? 0bc0 7412 50 50 ff7510 }
            // n = 6, score = 100
            //   e8????????           |                     
            //   0bc0                 | or                  eax, eax
            //   7412                 | je                  0x14
            //   50                   | push                eax
            //   50                   | push                eax
            //   ff7510               | push                dword ptr [ebp + 0x10]

        $sequence_14 = { e8???????? 50 8d85dcfaffff 50 8d85d0f8ffff }
            // n = 5, score = 100
            //   e8????????           |                     
            //   50                   | push                eax
            //   8d85dcfaffff         | lea                 eax, [ebp - 0x524]
            //   50                   | push                eax
            //   8d85d0f8ffff         | lea                 eax, [ebp - 0x730]

        $sequence_15 = { 837df800 750f ff35???????? 8f0485fad24000 eb23 8b45f8 }
            // n = 6, score = 100
            //   837df800             | cmp                 dword ptr [ebp - 8], 0
            //   750f                 | jne                 0x11
            //   ff35????????         |                     
            //   8f0485fad24000       | pop                 dword ptr [eax*4 + 0x40d2fa]
            //   eb23                 | jmp                 0x25
            //   8b45f8               | mov                 eax, dword ptr [ebp - 8]

        $sequence_16 = { 8945d4 8b4dd4 3b4ddc 0f83c3000000 8b55d4 }
            // n = 5, score = 100
            //   8945d4               | mov                 dword ptr [ebp - 0x2c], eax
            //   8b4dd4               | mov                 ecx, dword ptr [ebp - 0x2c]
            //   3b4ddc               | cmp                 ecx, dword ptr [ebp - 0x24]
            //   0f83c3000000         | jae                 0xc9
            //   8b55d4               | mov                 edx, dword ptr [ebp - 0x2c]

        $sequence_17 = { ff7510 ff750c ff7508 8d8701050000 }
            // n = 4, score = 100
            //   ff7510               | push                dword ptr [ebp + 0x10]
            //   ff750c               | push                dword ptr [ebp + 0xc]
            //   ff7508               | push                dword ptr [ebp + 8]
            //   8d8701050000         | lea                 eax, [edi + 0x501]

        $sequence_18 = { 0f8e4b010000 8b5530 52 8b4520 50 }
            // n = 5, score = 100
            //   0f8e4b010000         | jle                 0x151
            //   8b5530               | mov                 edx, dword ptr [ebp + 0x30]
            //   52                   | push                edx
            //   8b4520               | mov                 eax, dword ptr [ebp + 0x20]
            //   50                   | push                eax

        $sequence_19 = { 8b4dec 2b4d20 83c101 51 8d4da0 }
            // n = 5, score = 100
            //   8b4dec               | mov                 ecx, dword ptr [ebp - 0x14]
            //   2b4d20               | sub                 ecx, dword ptr [ebp + 0x20]
            //   83c101               | add                 ecx, 1
            //   51                   | push                ecx
            //   8d4da0               | lea                 ecx, [ebp - 0x60]

        $sequence_20 = { 3b5375 60 d3e0 90 }
            // n = 4, score = 100
            //   3b5375               | cmp                 edx, dword ptr [ebx + 0x75]
            //   60                   | pushal              
            //   d3e0                 | shl                 eax, cl
            //   90                   | nop                 

        $sequence_21 = { e8???????? 0bc0 746b 59 2b4dfc }
            // n = 5, score = 100
            //   e8????????           |                     
            //   0bc0                 | or                  eax, eax
            //   746b                 | je                  0x6d
            //   59                   | pop                 ecx
            //   2b4dfc               | sub                 ecx, dword ptr [ebp - 4]

        $sequence_22 = { 0fadce c0cac2 8af4 f6c566 69d51a756497 69f10e99f8db }
            // n = 6, score = 100
            //   0fadce               | shrd                esi, ecx, cl
            //   c0cac2               | ror                 dl, 0xc2
            //   8af4                 | mov                 dh, ah
            //   f6c566               | test                ch, 0x66
            //   69d51a756497         | imul                edx, ebp, 0x9764751a
            //   69f10e99f8db         | imul                esi, ecx, 0xdbf8990e

        $sequence_23 = { 6a61 5e 03d6 52 }
            // n = 4, score = 100
            //   6a61                 | push                0x61
            //   5e                   | pop                 esi
            //   03d6                 | add                 edx, esi
            //   52                   | push                edx

        $sequence_24 = { dbe9 68912b4384 2383e08985e4 0572b6e2f4 fd }
            // n = 5, score = 100
            //   dbe9                 | fucomi              st(1)
            //   68912b4384           | push                0x84432b91
            //   2383e08985e4         | and                 eax, dword ptr [ebx - 0x1b7a7620]
            //   0572b6e2f4           | add                 eax, 0xf4e2b672
            //   fd                   | std                 

        $sequence_25 = { 6a00 68cee6ac00 52 50 e8???????? 898538fbffff }
            // n = 6, score = 100
            //   6a00                 | push                0
            //   68cee6ac00           | push                0xace6ce
            //   52                   | push                edx
            //   50                   | push                eax
            //   e8????????           |                     
            //   898538fbffff         | mov                 dword ptr [ebp - 0x4c8], eax

        $sequence_26 = { bf633629a8 02738f 1da2c9dde2 f4 16 }
            // n = 5, score = 100
            //   bf633629a8           | mov                 edi, 0xa8293663
            //   02738f               | add                 dh, byte ptr [ebx - 0x71]
            //   1da2c9dde2           | sbb                 eax, 0xe2ddc9a2
            //   f4                   | hlt                 
            //   16                   | push                ss

        $sequence_27 = { 33c0 8908 50 45 43 6f 6d }
            // n = 7, score = 100
            //   33c0                 | xor                 eax, eax
            //   8908                 | mov                 dword ptr [eax], ecx
            //   50                   | push                eax
            //   45                   | inc                 ebp
            //   43                   | inc                 ebx
            //   6f                   | outsd               dx, dword ptr [esi]
            //   6d                   | insd                dword ptr es:[edi], dx

        $sequence_28 = { 8f85fcfbffff 8d85f4fbffff 50 6a00 6a4a }
            // n = 5, score = 100
            //   8f85fcfbffff         | pop                 dword ptr [ebp - 0x404]
            //   8d85f4fbffff         | lea                 eax, [ebp - 0x40c]
            //   50                   | push                eax
            //   6a00                 | push                0
            //   6a4a                 | push                0x4a

        $sequence_29 = { 397844 7e26 33f6 e8???????? 8b4048 ff3430 53 }
            // n = 7, score = 100
            //   397844               | cmp                 dword ptr [eax + 0x44], edi
            //   7e26                 | jle                 0x28
            //   33f6                 | xor                 esi, esi
            //   e8????????           |                     
            //   8b4048               | mov                 eax, dword ptr [eax + 0x48]
            //   ff3430               | push                dword ptr [eax + esi]
            //   53                   | push                ebx

        $sequence_30 = { 0f8478010000 837de000 0f846e010000 68???????? ff75fc e8???????? 85c0 }
            // n = 7, score = 100
            //   0f8478010000         | je                  0x17e
            //   837de000             | cmp                 dword ptr [ebp - 0x20], 0
            //   0f846e010000         | je                  0x174
            //   68????????           |                     
            //   ff75fc               | push                dword ptr [ebp - 4]
            //   e8????????           |                     
            //   85c0                 | test                eax, eax

        $sequence_31 = { f4 16 ee 7f7b 36110b 33745571 de7e75 }
            // n = 7, score = 100
            //   f4                   | hlt                 
            //   16                   | push                ss
            //   ee                   | out                 dx, al
            //   7f7b                 | jg                  0x7d
            //   36110b               | adc                 dword ptr ss:[ebx], ecx
            //   33745571             | xor                 esi, dword ptr [ebp + edx*2 + 0x71]
            //   de7e75               | fidivr              word ptr [esi + 0x75]

    condition:
        7 of them and filesize < 568320
}